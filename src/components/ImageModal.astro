---
---

<div data-image-modal class="fixed inset-0 z-50 items-center justify-center cursor-zoom-out">
	<img data-modal-image class="object-contain" src="" alt="" />
	<div data-modal-meta class="image-meta" aria-live="polite">
		<span data-modal-meta-text></span>
	</div>
</div>

<style>
  [data-image-modal] {
    display: flex;
    background: rgba(0, 0, 0, 0.6);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    padding: 1.5rem;
    transition: opacity 200ms ease, visibility 0ms linear 200ms;
  }

  [data-image-modal].is-open {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transition: opacity 220ms ease;
  }

  [data-image-modal] [data-modal-image] {
    max-width: min(92vw, 1200px);
    max-height: 88vh;
    width: auto;
    height: auto;
    border-radius: 0.75rem;
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
    transform: scale(0.96);
    transition: transform 220ms ease;
    will-change: transform;
  }

  [data-image-modal].is-open [data-modal-image] {
    transform: scale(1);
  }

  [data-image-modal] [data-modal-meta] {
    position: absolute;
    left: 50%;
    bottom: calc(1.1rem - 6px);
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.92);
    color: #111827;
    font-size: 0.75rem;
    line-height: 1.4;
    padding: 0.45rem 0.75rem;
    border-radius: 0.6rem;
    max-width: min(92vw, 900px);
    white-space: nowrap;
    overflow-x: auto;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.2);
    opacity: 0;
    pointer-events: none;
    transition: opacity 200ms ease, bottom 200ms ease;
  }

  [data-image-modal] [data-modal-meta].is-visible {
    opacity: 1;
    bottom: 1.1rem;
  }

  [data-image-modal] .image-meta__key {
    color: #9ca3af;
    font-weight: 400;
  }

  @media (max-width: 768px) {
    [data-image-modal] {
      padding: 0.75rem;
    }

    [data-image-modal] [data-modal-image] {
      max-width: 94vw;
      max-height: 84vh;
    }

    [data-image-modal] [data-modal-meta] {
      bottom: 0.7rem;
      max-width: 94vw;
    }
  }
</style>

<script>
  import { getExifData, formatExifData } from '../lib/exif';

  // 獲取所有文章中的圖片
  const images = document.querySelectorAll('.prose img');
  const modal = document.querySelector('[data-image-modal]') as HTMLDivElement | null;
  const modalImg = modal?.querySelector('[data-modal-image]') as HTMLImageElement | null;
  const metaBox = modal?.querySelector('[data-modal-meta]') as HTMLDivElement | null;
  const metaText = modal?.querySelector('[data-modal-meta-text]') as HTMLSpanElement | null;
  
  let activeSrc = '';

  if (modal && modalImg && metaBox && metaText) {
    const setMetaState = (text: string, isVisible: boolean) => {
      metaText.textContent = text;
      // 清空任何動態添加的子元素（如 key-value pairs），只保留文本
      while (metaText.firstElementChild) {
        metaText.firstElementChild.remove();
      }
      metaBox.classList.toggle('is-visible', isVisible);
    };

    const displayMetaFields = (fields: { key: string; value: string }[]) => {
      metaText.textContent = '';
      const fragment = document.createDocumentFragment();
      
      fields
        .filter((field) => field.value)
        .forEach((field, index) => {
          if (index > 0) fragment.appendChild(document.createTextNode(' · '));
          
          const key = document.createElement('span');
          key.className = 'image-meta__key';
          key.textContent = field.key;
          
          const value = document.createElement('strong');
          value.textContent = field.value;
          
          fragment.append(key, document.createTextNode(' '), value);
        });
        
      metaText.appendChild(fragment);
      metaBox.classList.add('is-visible');
    };

    const openModal = async (img: HTMLImageElement) => {
      activeSrc = img.src;
      modalImg.src = img.src;
      modalImg.alt = img.alt;
      modal.classList.add('is-open');
      document.body.style.overflow = 'hidden';

      setMetaState('Reading metadata...', true);

      const meta = await getExifData(activeSrc);
      
      // 防止在異步加載期間切換了圖片或關閉了模態框
      if (activeSrc !== img.src || !modal.classList.contains('is-open')) return;

      if (!meta) {
        setMetaState('Metadata unavailable', true);
        return;
      }

      const fields = formatExifData(meta);
      if (fields.length === 0) {
        setMetaState('Metadata unavailable', true);
        return;
      }

      displayMetaFields(fields);
    };

    const closeModal = () => {
      modal.classList.remove('is-open');
      document.body.style.overflow = '';
      activeSrc = '';
      // 延遲隱藏 meta，配合 CSS 漸變
      setTimeout(() => setMetaState('', false), 200);
    };

    // 事件綁定
    images.forEach(img => {
      if (img instanceof HTMLImageElement) {
        img.addEventListener('click', () => openModal(img));
      }
    });

    modal.addEventListener('click', closeModal);
    modalImg.addEventListener('click', closeModal);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('is-open')) {
        closeModal();
      }
    });
  }
</script>
